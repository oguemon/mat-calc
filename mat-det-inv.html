<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no">
    <title>行列式・逆行列計算機(問題の答え合わせや試験対策に！) byおぐえもん.com</title>
    <link rel="stylesheet" href="./main.css">

    <!--OGP設定  -->
    <meta property="og:title" content="行列式・逆行列計算機(問題の答え合わせや試験対策に！)">
    <meta property="og:type" content="article">
    <meta property="og:url" content="https://oguemon.com/tools/calc/mat-det-inv.html">
    <meta property="og:image" content="https://oguemon.com/tools/calc/img/mat-det-inv-thum.png">
    <meta property="og:site_name" content="おぐえもん.com">
    <meta property="og:description" content="線形代数の「行列式」と「逆行列」を驚異的な速度で計算します。電卓のみならず計算ドリルにも使えます！">
    <meta property="fb:app_id" content="1846956072250071">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="@oguemon_com">

</head>
<body>
    <div id="header">
        <div class="wrapper">
            <div id="logo">
                <a href="https://oguemon.com/topic/study/linear-algebra/" target="_blenk">
                    <img src="img/mat-det-inv-logo.svg">
                </a>
            </div>
            <div id="twitter">
                <a href="http://twitter.com/share?url=https://oguemon.com/tools/calc/mat-det-inv.html&text=行列式・逆行列計算機(問題の答え合わせや試験対策に！) byおぐえもん.com&related=oguemon_com" target="_blenk">
                    <img src="img/twitter-icon.svg">
                </a>
            </div>
        </div>
    </div>
    <div id="main-contents">
        <div class="wrapper">
            <div class="container">
                <h2>行列の入力</h2>
                <div id="matrix_input"></div>
                <!-- 注意事項 -->
                <a id="input_attention_btn">▼入力時の注意事項を開く</a>
                <div id="input_attention">
                <ul>
                    <li>行列サイズは2x2〜10x10まで対応しています！</li>
                    <li>入出力は整数or小数で行われます。分数やルートには対応していません…</li>
                    <li>↑少なくとも分数には今後対応したいです（・3・）</li>
                    <li>計算結果は小数をある程度の桁で四捨五入して丸めています。表示する桁数は以下で設定可能です。</li>
                    <li>当計算機はLU分解というものを利用して行列式と逆行列を求値しています。</li>
                    <li>算出アルゴリズムの都合上、複雑な行列を与えた場合に本来行列式が0なのに超微小な数値を導出してしまい、存在しない逆行列を導出する場合があるのでご了承願います。</li>
                    <li>その他の不具合がございましたら、おぐえもん（<a href="https://twitter.com/oguemon_com" target="_blenk">@oguemon_com</a>）までご連絡ください。</li>
                    <li>当ページ下部にある免責事項等をお読みになった上でご利用願います。</li>
                </ul>
                </div>
                <!-- 計算ドリルモード -->
                <label>
                    <input type="checkbox" checked id="drill">
                    <span class="checkbox">計算ドリルモード<br><small>(テキトーな数字が入るから実際に解いて答えを確かめよう！)</small></span>
                </label>
                <!-- 結果の小数表示 -->
                <select id="show_digit">
                    <option value="0">結果を整数で表示</option>
                    <option value="1">結果を小数第1位まで表示</option>
                    <option value="2">結果を小数第2位まで表示</option>
                    <option value="3" selected>結果を小数第3位まで表示</option>
                    <option value="4">結果を小数第4位まで表示</option>
                    <option value="5">結果を小数第5位まで表示</option>
                    <option value="6">結果を小数第6位まで表示</option>
                    <option value="7">結果を小数第7位まで表示</option>
                </select>
                <!-- いろんなボタン -->
                <div id="button_box">
                    <input type="button" id="dim_add" value="次元＋">
                    <input type="button" id="dim_dec" value="次元ー">
                    <input type="button" id="reset" value="リセット">
                    <input type="button" id="calc" value="計算スタート">
                </div>
                <div id="error_msg_box"></div>
                <h2>結果の表示</h2>
                <div id="result">
                    <div id="matrix_A">「逆行列を計算」ボタンを押してください！</div>
                    <div id="matrix_detA"></div>
                    <div id="matrix_revA"></div>
                </div>
                <div id="pay-attention">
                    <div class="title">ご利用時の注意点</div>
                    <ul class="list">
                    <li>入力された値は、今後の精度改善などの目的のために利用および公開させていただく場合がございます。</li>
                    <li>当サービスを利用して生じた一切の損害およびトラブル等につきまして、運営者は一切の責任を負いません。</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    <div id="footer">
        <div class="wrapper">Copyright 2018 Oguemon All right reserved.</div>
    </div>
    <script>
    var btn_input_attention = document.getElementById('input_attention_btn');
    var select_digit = document.getElementById('show_digit');
    var check_drill = document.getElementById('drill');
    var btn_dimadd = document.getElementById('dim_add');
    var btn_dimdec = document.getElementById('dim_dec');
    var btn_reset  = document.getElementById('reset');
    var btn_calc   = document.getElementById('calc');
    
    var N = 3;
    var digit = 2;

    window.onload = function ()
    {
        updateInputForm ();
    };

    /*
     *  入力時の注意事項のリンクが開かれたら
     */
    btn_input_attention.onclick = function ()
    {
        var ele_input_attention = document.getElementById('input_attention');
        if (ele_input_attention.style.display != 'block')
        {
            btn_input_attention.innerHTML = '▲入力時の注意事項を閉じる';
            ele_input_attention.style.display = 'block';
        }
        else
        {
            btn_input_attention.innerHTML = '▼入力時の注意事項を開く';
            ele_input_attention.style.display = 'none';
        }
    }

    /*
     *  表示する小数以下の桁数を決めるセレクターを変更したら
     */
     select_digit.onchange = function ()
    {
        // 桁数を設定
        digit = select_digit.value;
    }

    /*
     *  計算ドリルモードを変更したら
     */
    check_drill.onchange = function ()
    {
        updateInputForm();
    }

    /*
     *  次元を増やすボタンを押したら
     */
    btn_dimadd.onclick = function ()
    {
        N = Math.min(N+1, 10);
        updateInputForm ();
        return;
    }

    /*
     *  次元を減らすボタンを押したら
     */
    btn_dimdec.onclick = function ()
    {
        N = Math.max(N-1, 2);
        updateInputForm ();
        return;
    }

    /*
     *  リセットボタンを押したら
     */
     btn_reset.onclick = function ()
    {
        var agree = window.confirm("行列の中身を全てリセットします。\nよろしいでしょうか？");
        if (agree)
        {
            updateInputForm ();
        }
        return;
    }

    /*
     *  計算ボタンを押したら
     */
    btn_calc.onclick = function ()
    {
        var start_ms = new Date().getTime();
        var A = [];
        var ele; // id要素を格納
        
        // 行列の入力
        var input_error = false;
        for (var i = 0; i < N * N; i++)
        {
            var ele = document.getElementById('a-' + i);
            var tmp_value = ele.value;
            if (isNumber(tmp_value))
            {
                A[i] = tmp_value;
                ele.style.border = '1px solid #dddddd';
            }
            else
            {
                ele.style.border = '2px solid #EB040D';
                input_error = true;
            }
        }
        if (input_error)
        {
            ele = document.getElementById('error_msg_box');
            ele.innerHTML = '<div id="error_msg">正しく入力して下さい！</div>';
            return;
        }

        // 入力した行列のアップ
        ele = document.getElementById('matrix_A');
        ele.innerHTML  = '<h3>入力した行列</h3>'
        ele.innerHTML += matrix2MathJax(A, 'A'); 
        MathJax.Hub.Typeset(ele);
        
        // LU分解と行列式を求める
        var LU = makeLU(A);
        var det_A = makeDeterminant(LU);
        // 表示する小数以下の桁数調整
        var digit_adjuster = Math.pow(10, digit);
        // 行列式のアップ
        ele = document.getElementById('matrix_detA');
        ele.innerHTML  = '<h3>行列式</h3>'
        ele.innerHTML += '$$|A|=' + (Math.round(det_A * digit_adjuster) / digit_adjuster) + '$$'; 
        MathJax.Hub.Typeset(ele);
        
        // 逆行列を求める
        var rev_A = makeInverceA(LU);
        // 求めた逆行列のアップ
        ele = document.getElementById('matrix_revA');
        ele.innerHTML  = '<h3>逆行列</h3>'
        ele.innerHTML += (det_A == 0)? '<em>逆行列はありません！</em>' : matrix2MathJax(rev_A, 'A^{-1}');
        MathJax.Hub.Typeset(ele);
        
        console.log('処理時間：' + (new Date().getTime() - start_ms) + ' ms');
        return;
    }

    /*
     *  数字かどうかのチェック
     */
    function isNumber(num_value){
        // チェック条件パターン
        var pattern = /^[-]?([1-9]\d*|0)(\.\d+)?$/;
        // 数値チェック
        return pattern.test(num_value);
    }

    /*
     *  フォームの描画
     */
     function updateInputForm ()
    {
        var mat_input = document.getElementById('matrix_input');
        var drill  = check_drill.checked;
        var string = '';
        for (var i = 0; i < N * N; i++)
        {
            //ドリルモードかどうかで数字をランダムにするか決める
            var input_val = (drill)? Math.floor(Math.random() * 10) : 0;
            string += '<input type="text" id="a-' + i + '" name="matrix[]" value="' + input_val + '">';
            if ((i + 1) % N == 0) string +='<br>';
        }

        mat_input.innerHTML = string;
    }

    /*
     *  行列をmathjaxで出力
     */
    function matrix2MathJax(matrix, name)
    {
        var string = '$$' + name + ' = \\left(\\begin{array}{ccc}';
        var digit_adjuster = Math.pow(10, digit);
        for (var i = 0; i < matrix.length; i++)
        {
            // 桁を丸める
            string += (Math.round(matrix[i] * digit_adjuster) / digit_adjuster);
            // 行列の隙間か改行か
            string += ((i + 1) % N == 0) ? '\\\\' : ' & ';
        }
        string += '\\end{array}\\right)$$';

        return string;
    }

    /*
     *  行列式を求める
     */
    function makeDeterminant(LU)
    {
        var L = LU.L;
        var U = LU.U;

        var det = 1;

        // Uの対角成分の積を求める
        for (var i = 0; i < N; i++)
        {
            det *= LU.U[i + i * N];
        }

        return det;
    }

    /*
     *  掃き出し計算をして逆行列を求める
     *  (三角行列なので効率的)
     */
    function makeInverceA(LU)
    {
        var L = LU.L;
        var U = LU.U;

        // 逆行列が定義されるかどうかをチェック
        if (makeDeterminant(LU) == 0)
        {
            return false;
        }

        /*
         *  逆行列の卵を単位行列の形に初期化
         *  (単位行列にすることで効率化する)
         */
        var B = (new Array(L.length)).fill(0);
        var C = (new Array(L.length)).fill(0);
        for (var i = 0; i < N; i++)
        {
            B[i + i * N] = 1;
            C[i + i * N] = 1;
        }

        /*
         *  LC = EとなるC(即ちLの逆行列)を求める
         */
        // 左上から、行→列の順に走査
        for (var j = 0; j < N; j++)
        {
            for (var i = j; i < N; i++)
            {
                // Uにとって対角行列より右側を既出の値で計算
                for (var k = j; k < i; k++)
                {
                    C[j + i * N] -= L[k + i * N] * C[j + k * N];
                }
            }
        }

        /*
         *  UB = EとなるB(即ちUの逆行列)を求める
         */
        // 右下から、行→列の順に走査
        for (var j = N - 1; 0 <= j; j--)
        {
            for (var i = j; 0 <= i; i--)
            {
                // Uにとって対角行列より右側を既出の値で計算
                for (var k = j; i < k; k--)
                {
                    B[j + i * N] -= U[k + i * N] * B[j + k * N];
                }
                // 最後に対角成分で割る
                B[j + i * N] /= U[i + i * N];
            }
        }

        /*
         * A逆行列をU^(-1)L^(-1)から求める
         */
        var rev_UL = multSquareMatrix (B, C);
        var rev_A = [];
        for (var j = 0; j < LU.pivot.length; j++)
        {
            for (var i = 0; i < N; i++)
            {
                rev_A[LU.pivot[j] + i * N] = rev_UL[j + i * N];
            }
        }
        return rev_A;
    }

    // LU分解を行う
    function makeLU (A)
    {
        // 行の入れ替え状況を格納する配列
        var pivot = [];
        for (var i = 0; i < N; i++) {
            pivot[i] = i;
        }

        // i行目について扱う
        for (var i = 0; i < N - 1; i++)
        {
            /*
             * 対角成分が0にならないように行を入れ替え
             */
            // i+1行目以下のi列目成分の中で絶対値が最大のものを求める
            var max = {'line': i, 'value': Math.abs(A[i + i * N])};
            for (var j = i + 1; j < N; j++)
            {
                if (Math.abs(A[i + j * N]) > max.value)
                {
                    max.line  = j;
                    max.value = Math.abs(A[i + j * N]);
                }
            }
            // 最大が0だったら、i行目以下が全部0ということ（おしり）
            if (max.value == 0)
            {
                continue;
            }
            // 最大が0じゃなくて対角成分以上の行があった→行を入れ替える
            if (i != max.line)
            {
                for (var j = 0; j < N; j++)
                {
                    // 行の入れ替え
                    var tmp = A[j + i * N];
                    A[j + i * N] = A[j + max.line * N];
                    A[j + max.line * N] = tmp;
                }
                // ピボット配列（入替記録）の更新
                tmp = pivot[i]
                pivot[i] = pivot[max.line];
                pivot[max.line] = tmp;
            }

            /*
             * i行目のの割り算(U作り)
             */
            for (var j = i + 1; j < N; j++)
            {
                A[i + j * N] /= A[i + i * N];
            }
            /*
             * j行目とi列目で行列を作って余因子から引く
             */
            for (var n = i + 1; n < N; n++)
            {
                for (var m = i + 1; m < N; m++)
                {
                    A[m + n * N] -= A[m + i * N] * A[i + n * N];
                }
            }
        }

        // LとUを出す
        var L = A.slice();
        var U = A.slice();
        for (var i = 0; i < N; i++)
        {
            for (var j = 0; j < N; j++)
            {
                if (i < j)
                {
                    L[j + i * N] = 0;
                }
                else if (i > j)
                {
                    U[j + i * N] = 0;
                }
                else
                {
                    L[j + i * N] = 1;
                }
            }
        }

        return {'L': L, 'U': U, 'LxU': multSquareMatrix(L, U), 'pivot': pivot};
    }

    /*
     *  正方行列のかけ算をする（定義できないときはfalse）
     */
    function multSquareMatrix (A, B)
    {
        // AとBの要素数がマッチしない or 要素数が平方数じゃない
        if (A.length != B.length || !Number.isInteger(Math.pow(A.length, 0.5)))
        {
            return false;
        }

        var AB = [];
        var sum = 0;
        for (var i = 0; i < N; i++)
        {
            for (var j = 0; j < N; j++)
            {
                sum = 0;
                for (var k = 0; k < N; k++)
                {
                    sum += A[k + i * N] * B[j + k * N];
                }
                AB[j + i * N] = sum;
            }
        }

        return AB;
    }
    </script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-MML-AM_CHTML' async></script>
</body>
</html>